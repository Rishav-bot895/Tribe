<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet">
</head>

<body>

  {% include 'navbar.html' %}

  <!-- CSRF token for AJAX -->
  <form style="display:none;">
    {% csrf_token %}
  </form>

  <div class="container mt-4">

    <!-- Create Post -->
    <div class="mb-4">
      <a href="{% url 'create_post' %}" class="btn btn-primary">
        Create Post
      </a>
    </div>

    <!-- POSTS FEED -->
    {% for post in posts %}
      <div class="card mb-4">
        <div class="card-body">

          <!-- Author + time -->
          <h6 class="card-subtitle mb-2 text-muted">
            {{ post.author.username }}
            ¬∑ {{ post.created_at|date:"M d, Y H:i" }}
          </h6>

          <!-- Caption -->
          <p class="card-text">{{ post.caption }}</p>

          <!-- Image -->
          {% if post.image %}
            <img src="{{ post.image.url }}"
                 class="img-fluid rounded mb-2">
          {% endif %}

          <!-- ACTIONS -->
          <div class="d-flex gap-2 mb-2">

            <!-- LIKE BUTTON -->
            <button
              class="btn btn-sm btn-outline-danger"
              id="like-btn-{{ post.id }}"
              onclick="toggleLike({{ post.id }})">
              ‚ù§Ô∏è Like
            </button>

            <!-- LIKE COUNT -->
            <span id="like-count-{{ post.id }}">
              {{ post.likes.count }} likes
            </span>

            <!-- COMMENT BUTTON -->
            <button
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="modal"
              data-bs-target="#commentModal"
              data-post-id="{{ post.id }}">
              Comment
            </button>

          </div>

          <!-- COMMENTS -->
          <div id="comments-{{ post.id }}" class="mt-2">
            {% for comment in post.comments.all %}
              <p class="mb-1">
                <strong>{{ comment.author.username }}</strong>:
                {{ comment.content }}
              </p>
            {% empty %}
              <p class="text-muted mb-1">No comments yet.</p>
            {% endfor %}
          </div>

        </div>
      </div>
    {% empty %}
      <p class="text-muted">No posts yet.</p>
    {% endfor %}

  </div>

  <!-- COMMENT MODAL -->
  <div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Add Comment</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <textarea
            id="commentContent"
            class="form-control"
            placeholder="Write a comment..."></textarea>
          <input type="hidden" id="commentPostId">
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button class="btn btn-primary"
                  onclick="submitComment()">
            Post
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js">
  </script>

  <!-- JAVASCRIPT -->
  <script>
    // Get CSRF token
    function getCSRFToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    /* =======================
       COMMENTS (MODAL + AJAX)
       ======================= */

    const commentModal = document.getElementById('commentModal');

    commentModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const postId = button.getAttribute('data-post-id');
      document.getElementById('commentPostId').value = postId;
    });

    function submitComment() {
      const postId = document.getElementById('commentPostId').value;
      const content = document.getElementById('commentContent').value.trim();

      if (!content) {
        alert("Comment cannot be empty");
        return;
      }

      fetch("{% url 'add_comment' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          post_id: postId,
          content: content
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }

        const commentsDiv = document.getElementById(`comments-${postId}`);
        commentsDiv.innerHTML += `
          <p class="mb-1">
            <strong>${data.author}</strong>: ${data.content}
          </p>
        `;

        document.getElementById('commentContent').value = '';
        bootstrap.Modal.getInstance(commentModal).hide();
      });
    }

    /* =======================
       LIKES (AJAX TOGGLE)
       ======================= */

    function toggleLike(postId) {
      fetch("{% url 'toggle_like' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          post_id: postId
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }

        document.getElementById(`like-count-${postId}`).innerText =
          `${data.like_count} likes`;

        const btn = document.getElementById(`like-btn-${postId}`);
        btn.innerText = data.liked ? "üíî Unlike" : "‚ù§Ô∏è Like";
      });
    }
  </script>

</body>
</html>
